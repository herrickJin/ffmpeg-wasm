import{F as m}from"./vendor-D-QKHKUd.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const g=a=>new Promise((e,t)=>{const i=new FileReader;i.onload=()=>{const{result:r}=i;r instanceof ArrayBuffer?e(new Uint8Array(r)):e(new Uint8Array)},i.onerror=r=>{var o,s;t(Error(`File could not be read! Code=${((s=(o=r==null?void 0:r.target)==null?void 0:o.error)==null?void 0:s.code)||-1}`))},i.readAsArrayBuffer(a)}),p=async a=>{let e;if(typeof a=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(a)?e=atob(a.split(",")[1]).split("").map(t=>t.charCodeAt(0)):e=await(await fetch(a)).arrayBuffer();else if(a instanceof URL)e=await(await fetch(a)).arrayBuffer();else if(a instanceof File||a instanceof Blob)e=await g(a);else return new Uint8Array;return new Uint8Array(e)};class y{constructor(){this.ffmpeg=null,this.originalFile=null,this.isConverting=!1,this.startTime=null,this.mediaSource=null,this.sourceBuffer=null,this.supportedMimeType=null,this.streamQueue=[],this.isStreaming=!1,this.performanceMetrics={conversionTime:0,originalSize:0,convertedSize:0,memoryUsage:0},this.debugMode=this.getDebugMode(),this.bufferMonitor={totalChunksAdded:0,totalChunksProcessed:0,totalBytesProcessed:0,lastErrorTime:null,consecutiveErrors:0,bufferHealth:"good",lastBufferCheck:Date.now()},this.performanceMonitor=null,this.setupEventListeners(),this.log("FFmpeg WASM Demo å¼€å§‹åˆå§‹åŒ–"),this.debugMode&&this.log("è°ƒè¯•æ¨¡å¼å·²å¯ç”¨","debug"),this.initFFmpeg()}async init(){await this.initFFmpeg(),this.setupEventListeners(),this.log("FFmpeg WASM Demo åˆå§‹åŒ–å®Œæˆ")}async initFFmpeg(){this.log("æ­£åœ¨åŠ è½½ FFmpeg WASM...");try{this.ffmpeg=new m,this.ffmpeg.on("log",e=>{this.log(`FFmpeg: ${e.message}`)}),this.ffmpeg.on("progress",e=>{this.updateProgress(e)}),await this.ffmpeg.load({corePath:"https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js"}),this.log("FFmpeg WASM åŠ è½½å®Œæˆ"),this.originalFile&&(document.getElementById("convertBtn").disabled=!1,this.log("è½¬ç åŠŸèƒ½å·²å¯ç”¨"))}catch(e){this.log(`FFmpeg WASM åŠ è½½å¤±è´¥: ${e.message}`,"error"),console.error("FFmpeg åŠ è½½å¤±è´¥:",e),this.log("æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å·²å¯ç”¨ï¼Œä½†è½¬ç åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨","warning")}}async checkFilesystemHealth(){try{const e="test_fs_health.tmp",t=new Uint8Array([1,2,3,4,5]);return await this.ffmpeg.writeFile(e,t),await this.ffmpeg.deleteFile(e),this.log("FFmpeg æ–‡ä»¶ç³»ç»Ÿå¥åº·æ£€æŸ¥é€šè¿‡"),!0}catch(e){return this.log(`FFmpeg æ–‡ä»¶ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥: ${e.message}`,"error"),!1}}getDebugMode(){const e=new URLSearchParams(window.location.search);if(e.has("debug"))return e.get("debug")==="true";try{const t=localStorage.getItem("ffmpeg-debug-mode");if(t!==null)return t==="true"}catch{}return!1}setupEventListeners(){const e=document.getElementById("uploadSection"),t=document.getElementById("fileInput"),i=document.getElementById("convertBtn"),r=document.getElementById("stopStreamingBtn"),o=document.getElementById("crf"),s=document.getElementById("crfValue");if(!e||!t||!i){this.log("é”™è¯¯: æ— æ³•æ‰¾åˆ°é¡µé¢å…ƒç´ ","error");return}this.log("è®¾ç½®äº‹ä»¶ç›‘å¬å™¨..."),e.addEventListener("click",()=>{this.log("ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ"),t.click()}),e.addEventListener("dragover",n=>{n.preventDefault(),e.classList.add("dragover"),this.log("æ‹–æ‹½æ–‡ä»¶åˆ°ä¸Šä¼ åŒºåŸŸ")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover"),this.log("æ‹–æ‹½ç¦»å¼€ä¸Šä¼ åŒºåŸŸ")}),e.addEventListener("drop",n=>{n.preventDefault(),e.classList.remove("dragover"),this.log("æ–‡ä»¶å·²æ‹–æ‹½åˆ°ä¸Šä¼ åŒºåŸŸ");const u=n.dataTransfer.files;u.length>0&&this.handleFileSelect(u[0])}),t.addEventListener("change",n=>{this.log("æ–‡ä»¶é€‰æ‹©å™¨å‘ç”Ÿå˜åŒ–"),n.target.files.length>0&&this.handleFileSelect(n.target.files[0])}),i.addEventListener("click",()=>{this.isConverting||this.startConversion()}),r&&r.addEventListener("click",()=>{this.stopStreaming(),r.style.display="none",i.style.display="block"}),o.addEventListener("input",n=>{s.textContent=n.target.value}),document.addEventListener("keydown",n=>{n.ctrlKey&&n.shiftKey&&n.key==="D"&&(n.preventDefault(),this.toggleDebugMode())})}toggleDebugMode(){this.debugMode=!this.debugMode;try{localStorage.setItem("ffmpeg-debug-mode",this.debugMode.toString())}catch{console.warn("æ— æ³•ä¿å­˜è°ƒè¯•æ¨¡å¼è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨")}const e=this.debugMode?"å·²å¯ç”¨":"å·²ç¦ç”¨";this.log(`è°ƒè¯•æ¨¡å¼${e}`,"info"),this.debugMode&&(this.log("å½“å‰ç³»ç»ŸçŠ¶æ€:","debug"),this.log(`- FFmpeg çŠ¶æ€: ${this.ffmpeg?"å·²åŠ è½½":"æœªåŠ è½½"}`,"debug"),this.log(`- æ˜¯å¦æ­£åœ¨è½¬ç : ${this.isConverting}`,"debug"),this.log(`- æ˜¯å¦æ­£åœ¨æµå¼æ’­æ”¾: ${this.isStreaming}`,"debug"),this.log(`- é˜Ÿåˆ—é•¿åº¦: ${this.streamQueue.length}`,"debug"),this.log(`- MediaSource çŠ¶æ€: ${this.mediaSource?this.mediaSource.readyState:"ä¸å­˜åœ¨"}`,"debug"),this.log(`- SourceBuffer çŠ¶æ€: ${this.sourceBuffer?"å­˜åœ¨":"ä¸å­˜åœ¨"}`,"debug"))}handleFileSelect(e){if(!e.type.startsWith("video/")){this.log("è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶","error");return}this.originalFile=e,this.performanceMetrics.originalSize=e.size,this.displayOriginalVideo(e);const t=document.getElementById("convertBtn");this.ffmpeg?(t.disabled=!1,this.log(`å·²é€‰æ‹©æ–‡ä»¶: ${e.name} (${this.formatFileSize(e.size)})`)):(t.disabled=!0,this.log(`å·²é€‰æ‹©æ–‡ä»¶: ${e.name} (${this.formatFileSize(e.size)})`,"warning"),this.log("FFmpeg æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•","warning"))}displayOriginalVideo(e){const t=document.getElementById("originalVideoContainer"),i=document.createElement("video");i.src=URL.createObjectURL(e),i.controls=!0,i.style.maxWidth="100%",i.style.maxHeight="400px",t.innerHTML="",t.appendChild(i),i.addEventListener("loadedmetadata",()=>{this.log(`åŸå§‹è§†é¢‘ä¿¡æ¯: ${i.videoWidth}x${i.videoHeight}, ${i.duration.toFixed(2)}ç§’`)})}async startConversion(){if(!this.originalFile||this.isConverting)return;this.isConverting=!0,this.startTime=performance.now();const e=document.getElementById("convertBtn"),t=document.getElementById("stopStreamingBtn"),i=document.getElementById("progressSection"),r=document.getElementById("streamingMode").value;e.innerHTML='è½¬ç ä¸­<span class="loading"></span>',e.disabled=!0,i.style.display="block",r==="realtime"&&(e.style.display="none",t.style.display="block"),this.log("å¼€å§‹è½¬ç ...");try{await this.convertVideo(),this.log("è½¬ç å®Œæˆ")}catch(o){this.log(`è½¬ç å¤±è´¥: ${o.message}`,"error"),console.error("è½¬ç å¤±è´¥:",o)}finally{this.isConverting=!1,e.innerHTML="å¼€å§‹è½¬ç ",e.disabled=!1,e.style.display="block",t.style.display="none"}}async convertVideo(){const e=document.getElementById("outputFormat").value,t=document.getElementById("videoCodec").value,i=document.getElementById("crf").value,r=document.getElementById("preset").value,o=document.getElementById("threads").value,s=document.getElementById("performanceMode").value,n=document.getElementById("hardwareAcceleration").value,u=document.getElementById("streamingMode").value,l=`converted_${Date.now()}.${e}`;if(this.log("=== è½¬ç å¼€å§‹ ==="),this.log(`è¾“å…¥æ–‡ä»¶: ${this.originalFile.name} (${this.formatFileSize(this.originalFile.size)})`),this.log(`è¾“å‡ºæ ¼å¼: ${e}`),this.log(`è§†é¢‘ç¼–ç å™¨: ${t}`),this.log(`è´¨é‡è®¾ç½®: CRF=${i}`),this.log(`é€Ÿåº¦é¢„è®¾: ${r}`),this.log(`çº¿ç¨‹æ•°: ${o==="0"?"è‡ªåŠ¨":o+" çº¿ç¨‹"}`),this.log(`æ€§èƒ½æ¨¡å¼: ${this.getPerformanceModeText(s)}`),this.log(`ç¡¬ä»¶åŠ é€Ÿ: ${this.getHardwareAccelerationText(n)}`),this.log(`æµå¼å¤„ç†: ${this.getStreamingModeText(u)}`),this.log("æ£€æŸ¥ FFmpeg æ–‡ä»¶ç³»ç»ŸçŠ¶æ€..."),!await this.checkFilesystemHealth())throw new Error("FFmpeg æ–‡ä»¶ç³»ç»ŸçŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•è¿›è¡Œè½¬ç ");this.log("æ­£åœ¨å°†æ–‡ä»¶å†™å…¥ FFmpeg æ–‡ä»¶ç³»ç»Ÿ...");try{await this.ffmpeg.writeFile("input.mp4",await p(this.originalFile)),this.log("æ–‡ä»¶å†™å…¥å®Œæˆ")}catch(c){throw this.log(`æ–‡ä»¶å†™å…¥å¤±è´¥: ${c.message}`,"error"),new Error(`æ— æ³•å†™å…¥æ–‡ä»¶åˆ°FFmpegæ–‡ä»¶ç³»ç»Ÿ: ${c.message}`)}u==="none"?await this.normalConversion({input:"input.mp4",output:l,videoCodec:t,crf:i,preset:r,threads:o,performanceMode:s,hardwareAcceleration:n,outputFormat:e}):u==="segment"?await this.segmentedConversion({input:"input.mp4",output:l,videoCodec:t,crf:i,preset:r,threads:o,performanceMode:s,hardwareAcceleration:n,outputFormat:e}):u==="realtime"&&await this.realtimeConversion({input:"input.mp4",output:l,videoCodec:t,crf:i,preset:r,threads:o,performanceMode:s,hardwareAcceleration:n,outputFormat:e}),this.log("æ­£åœ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶...");try{await this.ffmpeg.deleteFile("input.mp4"),this.log("å·²åˆ é™¤è¾“å…¥æ–‡ä»¶")}catch(c){this.log(`åˆ é™¤è¾“å…¥æ–‡ä»¶å¤±è´¥: ${c.message}`,"warning")}try{await this.ffmpeg.deleteFile(l),this.log("å·²åˆ é™¤è¾“å‡ºæ–‡ä»¶")}catch(c){this.log(`åˆ é™¤è¾“å‡ºæ–‡ä»¶å¤±è´¥: ${c.message}`,"warning")}this.log("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"),this.log("=== è½¬ç å®Œæˆ ===")}displayConvertedVideo(e,t){const i=document.getElementById("convertedVideoContainer"),r=document.createElement("video");r.src=URL.createObjectURL(e),r.controls=!0,r.autoplay=!0,r.muted=!0,r.style.maxWidth="100%",r.style.maxHeight="400px",i.innerHTML="",i.appendChild(r);const o=document.createElement("a");o.href=r.src,o.download=t,o.textContent=`ä¸‹è½½ ${t}`,o.style.display="block",o.style.marginTop="10px",o.style.color="#667eea",o.style.textDecoration="none",i.appendChild(o);const s=document.createElement("button");s.textContent="ğŸ”Š å–æ¶ˆé™éŸ³",s.style.marginTop="10px",s.style.padding="8px 16px",s.style.backgroundColor="#667eea",s.style.color="white",s.style.border="none",s.style.borderRadius="5px",s.style.cursor="pointer",s.addEventListener("click",()=>{r.muted=!r.muted,s.textContent=r.muted?"ğŸ”Š å–æ¶ˆé™éŸ³":"ğŸ”‡ é™éŸ³",!r.muted&&r.paused&&r.play().catch(n=>{this.log(`è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ${n.message}`,"warning")})}),i.appendChild(s),r.addEventListener("loadedmetadata",()=>{this.log(`è½¬ç åè§†é¢‘ä¿¡æ¯: ${r.videoWidth}x${r.videoHeight}, ${r.duration.toFixed(2)}ç§’`),this.attemptAutoPlay(r)}),r.addEventListener("canplay",()=>{this.attemptAutoPlay(r)})}updateProgress(e){const t=document.getElementById("progressFill"),i=document.getElementById("progressText");if(!e||typeof e!="object"){this.log("è¿›åº¦æ•°æ®æ— æ•ˆ","warning");return}let r=0;if(e.ratio!==void 0&&e.ratio!==null&&!isNaN(e.ratio)?r=Math.round(e.ratio*100):e.progress!==void 0&&e.progress!==null&&!isNaN(e.progress)?r=Math.round(e.progress*100):this.log("è¿›åº¦æ¯”ç‡æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼ 0%","warning"),r=Math.max(0,Math.min(100,r)),t.style.width=`${r}%`,i.textContent=`è½¬ç è¿›åº¦: ${r}%`,e.time!==void 0&&e.time!==null&&!isNaN(e.time)){const o=this.formatTime(e.time);i.textContent+=` | å·²å¤„ç†: ${o}`,r%10===0&&r>0&&this.log(`è½¬ç è¿›åº¦: ${r}% - å·²å¤„ç†æ—¶é—´: ${o}`)}if(e.duration!==void 0&&e.duration!==null&&!isNaN(e.duration)&&e.time!==void 0&&e.time!==null&&!isNaN(e.time)){const o=Math.max(0,e.duration-e.time),s=this.formatTime(o);this.log(`è¯¦ç»†è¿›åº¦: ${r}% | å·²ç”¨: ${this.formatTime(e.time)} | å‰©ä½™: ${s}`)}this.log(`åŸå§‹è¿›åº¦æ•°æ®: ${JSON.stringify(e)}`,"debug")}updatePerformanceMetrics(){const e=this.performanceMetrics,t=document.getElementById("performanceInfo"),i=(e.conversionTime/1e3).toFixed(2),r=((e.convertedSize-e.originalSize)/e.originalSize*100).toFixed(1),o=(e.originalSize/1024/1024/(e.conversionTime/1e3)).toFixed(2);if(document.getElementById("conversionTime").textContent=`${i} ç§’`,document.getElementById("fileSizeChange").textContent=`${r>0?"+":""}${r}%`,document.getElementById("processingSpeed").textContent=`${o} MB/s`,performance.memory){const s=(performance.memory.usedJSHeapSize/1024/1024).toFixed(1);document.getElementById("memoryUsage").textContent=`${s} MB`,e.memoryUsage=parseFloat(s)}else document.getElementById("memoryUsage").textContent="ä¸æ”¯æŒ";t.style.display="block",this.log(`æ€§èƒ½æŒ‡æ ‡ - æ—¶é—´: ${i}s, å¤§å°å˜åŒ–: ${r}%, é€Ÿåº¦: ${o}MB/s`)}log(e,t="info"){if(t==="debug"){this.debugMode&&(console.log(`[FFmpeg Demo DEBUG] ${e}`),this.debugMode&&this.addToLogUI(e,t));return}console.log(`[FFmpeg Demo] ${e}`),this.addToLogUI(e,t)}addToLogUI(e,t="info"){const i=document.getElementById("logSection"),r=document.getElementById("logContent");if(!i||!r){console.warn("æ—¥å¿—åŒºåŸŸå…ƒç´ ä¸å­˜åœ¨");return}i.style.display="block";const o=new Date().toLocaleTimeString(),s=document.createElement("div");s.style.marginBottom="4px";let n="#00ff00";t==="error"&&(n="#ff4444"),t==="warning"&&(n="#ffaa00"),t==="debug"&&(n="#888888"),s.innerHTML=`<span style="color: #888">${o}</span> <span style="color: ${n}">${e}</span>`,r.appendChild(s),r.scrollTop=r.scrollHeight}formatFileSize(e){if(e===0)return"0 Bytes";const t=1024,i=["Bytes","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,r)).toFixed(2))+" "+i[r]}formatTime(e){const t=Math.floor(e/3600),i=Math.floor(e%3600/60),r=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}buildOptimizedCommand(e){const{input:t,output:i,videoCodec:r,crf:o,preset:s,threads:n,performanceMode:u,hardwareAcceleration:l,outputFormat:h}=e,c=["-i",t];if(l!=="none"){const d=this.getHardwareAccelerationParams(l,r);c.push(...d)}const f=this.getPerformanceParams(u,r,o,s);return c.push(...f),n!=="0"&&c.push("-threads",n),c.push("-c:a","aac","-b:a","128k"),h==="mp4"&&c.push("-movflags","+faststart"),c.push("-y",i),c}getHardwareAccelerationParams(e,t){const i=[];switch(e){case"cuda":i.push("-hwaccel","cuda"),t==="libx264"?i.push("-c:v","h264_nvenc"):t==="libx265"&&i.push("-c:v","hevc_nvenc");break;case"qsv":i.push("-hwaccel","qsv"),t==="libx264"?i.push("-c:v","h264_qsv"):t==="libx265"&&i.push("-c:v","hevc_qsv");break;case"videotoolbox":i.push("-hwaccel","videotoolbox"),t==="libx264"&&i.push("-c:v","h264_videotoolbox");break;case"auto":i.push("-hwaccel","auto");break}return i}getPerformanceParams(e,t,i,r){const o=[];switch(e){case"speed":o.push("-c:v",t),o.push("-crf",Math.max(18,parseInt(i)+4).toString()),o.push("-preset",r==="veryslow"?"medium":"ultrafast"),o.push("-tune","fastdecode");break;case"quality":o.push("-c:v",t),o.push("-crf",Math.min(30,parseInt(i)-2).toString()),o.push("-preset",r==="ultrafast"?"medium":"slow"),o.push("-tune","film");break;case"lowcpu":o.push("-c:v",t),o.push("-crf",Math.max(18,parseInt(i)+6).toString()),o.push("-preset","ultrafast"),o.push("-vf","scale=1280:-2");break;default:o.push("-c:v",t),o.push("-crf",i),o.push("-preset",r);break}return o}getPerformanceModeText(e){return{balanced:"å¹³è¡¡æ¨¡å¼",speed:"é€Ÿåº¦ä¼˜å…ˆ",quality:"è´¨é‡ä¼˜å…ˆ",lowcpu:"ä½CPUå ç”¨"}[e]||e}getHardwareAccelerationText(e){return{none:"æ— ",auto:"è‡ªåŠ¨æ£€æµ‹",cuda:"CUDA (NVIDIA)",qsv:"Intel QSV",videotoolbox:"VideoToolbox (Mac)"}[e]||e}getStreamingModeText(e){return{none:"ç¦ç”¨",segment:"åˆ†æ®µè½¬ç ",realtime:"å®æ—¶è½¬ç "}[e]||e}async normalConversion(e){const t=this.buildOptimizedCommand(e);this.log(`æ‰§è¡Œå‘½ä»¤: ffmpeg ${t.join(" ")}`),this.log("å¼€å§‹è½¬ç å¤„ç†ï¼Œè¯·ç¨å€™...");try{await this.ffmpeg.exec(t),this.log("è½¬ç å‘½ä»¤æ‰§è¡Œå®Œæˆ")}catch(r){throw this.log(`FFmpeg æ‰§è¡Œå¤±è´¥: ${r.message}`,"error"),new Error(`è½¬ç æ‰§è¡Œå¤±è´¥: ${r.message}`)}this.log("æ­£åœ¨è¯»å–è½¬ç åçš„æ–‡ä»¶...");let i;try{i=await this.ffmpeg.readFile(e.output);const r=new Blob([i],{type:`video/${e.outputFormat}`});this.log(`è½¬ç åæ–‡ä»¶å¤§å°: ${this.formatFileSize(r.size)}`),this.performanceMetrics.convertedSize=r.size,this.performanceMetrics.conversionTime=performance.now()-this.startTime,this.log("æ­£åœ¨ç”Ÿæˆè½¬ç åçš„è§†é¢‘é¢„è§ˆ..."),this.displayConvertedVideo(r,e.output),this.updatePerformanceMetrics()}catch(r){throw this.log(`è¯»å–è½¬ç åæ–‡ä»¶å¤±è´¥: ${r.message}`,"error"),new Error(`æ— æ³•è¯»å–è½¬ç åçš„æ–‡ä»¶: ${r.message}`)}}async segmentedConversion(e){this.log("å¼€å§‹åˆ†æ®µè½¬ç å¤„ç†...");const t=10,i=[];for(let o=0;o<5;o++){const s=o*t,n=`segment_${o}.${e.outputFormat}`,u=["-ss",s.toString(),"-i",e.input,"-t",t.toString(),"-c:v",e.videoCodec,"-crf",e.crf,"-preset",e.preset,"-c:a","aac","-b:a","128k","-y",n];this.log(`è½¬ç ç¬¬ ${o+1} æ®µ (å¼€å§‹æ—¶é—´: ${s}s)...`);try{await this.ffmpeg.exec(u)}catch(h){this.log(`ç¬¬ ${o+1} æ®µè½¬ç å¤±è´¥: ${h.message}`,"error");continue}const l=await this.ffmpeg.readFile(n);i.push(l),await this.ffmpeg.deleteFile(n),this.log(`ç¬¬ ${o+1} æ®µè½¬ç å®Œæˆ`)}this.log("åˆå¹¶åˆ†æ®µæ–‡ä»¶...");const r=new Blob(i,{type:`video/${e.outputFormat}`});this.performanceMetrics.convertedSize=r.size,this.performanceMetrics.conversionTime=performance.now()-this.startTime,this.log("æ­£åœ¨ç”Ÿæˆè½¬ç åçš„è§†é¢‘é¢„è§ˆ..."),this.displayConvertedVideo(r,e.output),this.updatePerformanceMetrics(),this.log("åˆ†æ®µè½¬ç å®Œæˆ")}async realtimeConversion(e){this.log("å¼€å§‹å®æ—¶è½¬ç å’Œæµå¼æ’­æ”¾...");let t=0;const i=2;for(;t<i;){t++,this.log(`æµå¼æ’­æ”¾å°è¯• ${t}/${i}`);try{this.supportedMimeType=null,this.isStreaming=!0,this.streamQueue=[],this.bufferMonitor={totalChunksAdded:0,totalChunksProcessed:0,totalBytesProcessed:0,lastErrorTime:null,consecutiveErrors:0,bufferHealth:"good",lastBufferCheck:Date.now()},this.startPerformanceMonitoring(),await this.initMediaSource();const r=8;let o=0,s=0,n=0;const u=3;for(s=await this.getVideoDuration(e.input),this.log(`è§†é¢‘æ€»æ—¶é•¿: ${s}ç§’`),this.sourceBuffer&&(this.sourceBuffer.timestampOffset=0,this.log("è®¾ç½® SourceBuffer æ—¶é—´æˆ³åç§»ä¸º 0"));o*r<s&&this.isStreaming;){if(n>=u)throw this.log("è¿ç»­é”™è¯¯è¿‡å¤šï¼Œåœæ­¢æµå¼æ’­æ”¾","error"),new Error("æµå¼æ’­æ”¾è¿ç»­é”™è¯¯è¿‡å¤š");const l=o*r;let h=".ts";this.supportedMimeType&&(this.supportedMimeType.includes("video/mp4")?h=".mp4":this.supportedMimeType.includes("video/webm")&&(h=".webm"));const c=`chunk_${o}${h}`;try{this.log(`è½¬ç ç¬¬ ${o+1} ç‰‡ (å¼€å§‹æ—¶é—´: ${l}s, æ—¶é•¿: ${r}s)...`),await this.transcodeChunk({input:e.input,output:c,startTime:l,duration:r,videoCodec:e.videoCodec,crf:e.crf,preset:"ultrafast",outputFormat:h.substring(1)});let f;try{f=await this.ffmpeg.readFile(c),console.log("è¯»å–åˆ†ç‰‡æ•°æ®æˆåŠŸ",f),this.sourceBuffer&&o>0&&(this.sourceBuffer.timestampOffset=l,this.log(`æ›´æ–°æ—¶é—´æˆ³åç§»ä¸º: ${l}s`)),await this.addChunkToStreamWithRetry(f,3)}catch(d){throw this.log(`è¯»å–åˆ†ç‰‡æ–‡ä»¶å¤±è´¥: ${d.message}`,"error"),new Error(`æ— æ³•è¯»å–åˆ†ç‰‡æ–‡ä»¶: ${d.message}`)}try{await this.ffmpeg.deleteFile(c)}catch(d){this.log(`åˆ é™¤åˆ†ç‰‡æ–‡ä»¶å¤±è´¥: ${d.message}`,"warning")}o++,n=0,this.log(`ç¬¬ ${o} ç‰‡å·²æ·»åŠ åˆ°æ’­æ”¾é˜Ÿåˆ— (å·²å¤„ç†æ—¶é•¿: ${o*r}s)`),await new Promise(d=>setTimeout(d,200))}catch(f){if(n++,this.log(`è½¬ç ç¬¬ ${o+1} ç‰‡å¤±è´¥: ${f.message}`,"error"),console.error("åˆ†ç‰‡è½¬ç é”™è¯¯:",f),o*r>=s-r){this.log("å·²å¤„ç†åˆ°æœ€åä¸€ä¸ªåˆ†ç‰‡ï¼Œå¿½ç•¥é”™è¯¯","warning");break}await new Promise(d=>setTimeout(d,1e3))}}this.log("æ‰€æœ‰åˆ†ç‰‡è½¬ç å®Œæˆ");break}catch(r){if(this.log(`æµå¼æ’­æ”¾å°è¯• ${t} å¤±è´¥: ${r.message}`,"error"),console.error("å®æ—¶è½¬ç é”™è¯¯:",r),this.stopStreaming(),t>=i){this.log("æµå¼æ’­æ”¾å¤šæ¬¡å°è¯•å¤±è´¥ï¼Œé™çº§åˆ°æ™®é€šè½¬ç æ¨¡å¼","warning"),await this.fallbackToNormalConversion(e);return}this.log("ç­‰å¾… 2 ç§’åé‡è¯•..."),await new Promise(o=>setTimeout(o,2e3))}finally{this.isStreaming=!1,this.stopPerformanceMonitoring()}}this.performanceMetrics.conversionTime=performance.now()-this.startTime,this.updatePerformanceMetrics(),this.log("å®æ—¶è½¬ç å’Œæµå¼æ’­æ”¾å®Œæˆ")}async initMediaSource(){return new Promise((e,t)=>{if(!window.MediaSource){t(new Error("æµè§ˆå™¨ä¸æ”¯æŒMediaSource API"));return}this.mediaSource=new MediaSource,this.mediaSource.addEventListener("sourceopen",()=>{this.log("MediaSourceå·²æ‰“å¼€");try{const i=['video/mp2t; codecs="avc1.42E01E,mp4a.40.2"','video/mp4; codecs="avc1.42E01E,mp4a.40.2"','video/webm; codecs="vp9,opus"'];let r=null;for(const o of i)if(this.log(`æ£€æŸ¥ MIME ç±»å‹æ”¯æŒ: ${o}`),MediaSource.isTypeSupported(o)){r=o;break}if(!r){t(new Error("æµè§ˆå™¨ä¸æ”¯æŒä»»ä½•æµåª’ä½“è§†é¢‘æ ¼å¼"));return}this.log(`ä½¿ç”¨æ”¯æŒçš„ MIME ç±»å‹: ${r}`),this.supportedMimeType=r,this.sourceBuffer=this.mediaSource.addSourceBuffer(r),console.log("SourceBuffer åˆ›å»ºæˆåŠŸ",this.sourceBuffer),this.sourceBuffer.addEventListener("updateend",()=>{this.processStreamQueue()}),this.sourceBuffer.addEventListener("error",o=>{const s=o.message||o.error||JSON.stringify(o);this.log(`SourceBufferé”™è¯¯: ${s}`,"error"),console.error("SourceBufferé”™è¯¯è¯¦æƒ…:",o),this.diagnoseSourceBufferError(o)}),this.sourceBuffer.addEventListener("abort",o=>{this.log("SourceBufferæ“ä½œè¢«ä¸­æ­¢","warning")}),this.log("SourceBufferåˆ›å»ºæˆåŠŸ"),e()}catch(i){this.log(`åˆ›å»ºSourceBufferå¤±è´¥: ${i.message}`,"error"),console.error("åˆ›å»ºSourceBufferå¤±è´¥è¯¦æƒ…:",i),t(i)}}),this.mediaSource.addEventListener("error",i=>{const r=i.message||i.error||JSON.stringify(i);this.log(`MediaSourceé”™è¯¯: ${r}`,"error"),console.error("MediaSourceé”™è¯¯è¯¦æƒ…:",i)}),this.createStreamingVideo()})}createStreamingVideo(){const e=document.getElementById("convertedVideoContainer");e.innerHTML="";const t=document.createElement("video");t.src=URL.createObjectURL(this.mediaSource),t.controls=!0,t.autoplay=!0,t.muted=!0,t.style.maxWidth="100%",t.style.maxHeight="400px",t.style.backgroundColor="#000",t.addEventListener("error",o=>{this.log(`è§†é¢‘å…ƒç´ é”™è¯¯: ${t.error?t.error.message:"æœªçŸ¥é”™è¯¯"}`,"error"),this.updateStreamingStatus("è§†é¢‘æ’­æ”¾é”™è¯¯"),this.stopStreaming()}),e.appendChild(t);const i=document.createElement("div");i.id="streamingStatus",i.style.marginTop="10px",i.style.padding="10px",i.style.backgroundColor="#f0f0f0",i.style.borderRadius="5px",i.style.fontSize="14px",i.textContent="æ­£åœ¨å‡†å¤‡æµå¼æ’­æ”¾...",e.appendChild(i);const r=document.createElement("button");r.textContent="ğŸ”Š å–æ¶ˆé™éŸ³",r.style.marginTop="10px",r.style.padding="8px 16px",r.style.backgroundColor="#667eea",r.style.color="white",r.style.border="none",r.style.borderRadius="5px",r.style.cursor="pointer",r.addEventListener("click",()=>{t.muted=!t.muted,r.textContent=t.muted?"ğŸ”Š å–æ¶ˆé™éŸ³":"ğŸ”‡ é™éŸ³",!t.muted&&t.paused&&t.play().catch(o=>{this.log(`è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ${o.message}`,"warning")})}),e.appendChild(r),t.addEventListener("loadstart",()=>{this.updateStreamingStatus("å¼€å§‹åŠ è½½...")}),t.addEventListener("loadedmetadata",()=>{this.updateStreamingStatus("å…ƒæ•°æ®åŠ è½½å®Œæˆ"),this.attemptAutoPlay(t)}),t.addEventListener("canplay",()=>{this.updateStreamingStatus("å¯ä»¥æ’­æ”¾"),this.attemptAutoPlay(t)}),t.addEventListener("play",()=>{this.updateStreamingStatus("æ­£åœ¨æ’­æ”¾")}),t.addEventListener("pause",()=>{this.updateStreamingStatus("å·²æš‚åœ")}),t.addEventListener("waiting",()=>{this.updateStreamingStatus("ç¼“å†²ä¸­...")}),t.addEventListener("playing",()=>{this.updateStreamingStatus("æ­£åœ¨æ’­æ”¾")}),t.addEventListener("ended",()=>{this.updateStreamingStatus("æ’­æ”¾ç»“æŸ")}),t.addEventListener("stalled",()=>{this.updateStreamingStatus("ç½‘ç»œå¡é¡¿")}),this.waitForFirstChunkAndPlay(t)}updateStreamingStatus(e){const t=document.getElementById("streamingStatus");t&&(t.textContent=`æµå¼æ’­æ”¾çŠ¶æ€: ${e}`)}async attemptAutoPlay(e){if(!e||!this.mediaSource||this.mediaSource.readyState!=="open"){this.log("è§†é¢‘æˆ– MediaSource ä¸å¯ç”¨ï¼Œæ— æ³•è‡ªåŠ¨æ’­æ”¾","warning");return}if(this.sourceBuffer&&this.sourceBuffer.buffered.length>0&&this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1)<2){this.log("ç¼“å†²æ•°æ®ä¸è¶³ï¼Œç­‰å¾…æ›´å¤šæ•°æ®...","warning");return}if(e.paused)try{await e.play(),this.log("è§†é¢‘è‡ªåŠ¨æ’­æ”¾æˆåŠŸ"),this.updateStreamingStatus("æ­£åœ¨æ’­æ”¾")}catch(t){this.log(`è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ${t.message}`,"warning"),this.updateStreamingStatus("ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹æ’­æ”¾")}}waitForFirstChunkAndPlay(e){const t=setInterval(()=>{if(!this.sourceBuffer||!this.mediaSource||this.mediaSource.readyState!=="open"){clearInterval(t),this.log("MediaSource æˆ– SourceBuffer å·²ä¸å¯ç”¨","warning");return}let i=!1;try{i=this.streamQueue.length>0||this.sourceBuffer&&this.sourceBuffer.buffered.length>0}catch{clearInterval(t),this.log("SourceBuffer å·²è¢«ç§»é™¤ï¼Œåœæ­¢ç­‰å¾…","warning");return}i&&(clearInterval(t),this.log("æ£€æµ‹åˆ°è§†é¢‘æ•°æ®ï¼Œå°è¯•è‡ªåŠ¨æ’­æ”¾"),setTimeout(()=>{this.attemptAutoPlay(e)},500))},100);setTimeout(()=>{clearInterval(t),e&&e.paused&&this.log("ç­‰å¾…è§†é¢‘æ•°æ®è¶…æ—¶","warning")},3e4)}async transcodeChunk(e){let t="mpegts";this.supportedMimeType&&(this.supportedMimeType.includes("video/mp2t")?t="mpegts":this.supportedMimeType.includes("video/mp4")?t="mp4":this.supportedMimeType.includes("video/webm")&&(t="webm")),this.log(`ä½¿ç”¨è¾“å‡ºæ ¼å¼: ${t}`);let i=[];t==="mpegts"?i=["-ss",e.startTime.toString(),"-i",e.input,"-t",e.duration.toString(),"-c:v",e.videoCodec,"-crf",e.crf,"-preset","ultrafast","-c:a","aac","-b:a","128k","-mpegts_m2ts_mode","1","-f","mpegts","-y",e.output]:i=["-ss",e.startTime.toString(),"-i",e.input,"-t",e.duration.toString(),"-c:v",e.videoCodec,"-crf",e.crf,"-preset","ultrafast","-c:a","aac","-b:a","128k","-profile:v","baseline","-level","3.0","-movflags","+frag_keyframe+empty_moov+faststart+default_base_moof","-frag_duration",e.duration.toString(),"-f",t,"-y",e.output];try{await this.ffmpeg.exec(i),this.log(`åˆ†ç‰‡è½¬ç å®Œæˆ: ${e.output} (å¼€å§‹æ—¶é—´: ${e.startTime}s, æ—¶é•¿: ${e.duration}s)`)}catch(r){throw this.log(`åˆ†ç‰‡è½¬ç å¤±è´¥: ${r.message}`,"error"),new Error(`åˆ†ç‰‡è½¬ç å¤±è´¥: ${r.message}`)}}addChunkToStream(e){if(!this.isStreaming){this.log("æµå¼æ’­æ”¾å·²åœæ­¢ï¼Œè·³è¿‡æ·»åŠ åˆ†ç‰‡","warning");return}this.streamQueue.push(e),this.streamQueue.length===1&&this.log("ç¬¬ä¸€ä¸ªè§†é¢‘åˆ†ç‰‡å·²æ·»åŠ ï¼Œå‡†å¤‡æ’­æ”¾"),this.processStreamQueue()}async addChunkToStreamWithRetry(e,t=3){for(let i=1;i<=t;i++)try{return this.log(`å°è¯•æ·»åŠ åˆ†ç‰‡åˆ°æµ (ç¬¬ ${i} æ¬¡)`),new Promise((r,o)=>{(()=>{if(!this.isStreaming){o(new Error("æµå¼æ’­æ”¾å·²åœæ­¢"));return}this.streamQueue.push(e),this.processStreamQueue();const n=setTimeout(()=>{this.streamQueue.length===0?r():o(new Error("æ·»åŠ åˆ†ç‰‡è¶…æ—¶"))},5e3),u=setInterval(()=>{this.streamQueue.length===0&&(clearTimeout(n),clearInterval(u),r())},100)})()})}catch(r){if(this.log(`ç¬¬ ${i} æ¬¡æ·»åŠ åˆ†ç‰‡å¤±è´¥: ${r.message}`,"warning"),i===t)throw new Error(`æ·»åŠ åˆ†ç‰‡åˆ°æµå¤±è´¥ï¼Œå·²é‡è¯• ${t} æ¬¡`);await new Promise(o=>setTimeout(o,1e3))}}async fallbackToNormalConversion(e){this.log("å¼€å§‹é™çº§åˆ°æ™®é€šè½¬ç æ¨¡å¼...","warning");try{this.updateStreamingStatus("æ­£åœ¨é™çº§åˆ°æ™®é€šè½¬ç æ¨¡å¼..."),await this.normalConversion(e),this.log("å·²æˆåŠŸé™çº§åˆ°æ™®é€šè½¬ç æ¨¡å¼","info")}catch(t){throw this.log(`é™çº§è½¬ç ä¹Ÿå¤±è´¥: ${t.message}`,"error"),t}}processStreamQueue(){if(!this.sourceBuffer||!this.mediaSource||this.mediaSource.readyState!=="open"){this.log("MediaSource æˆ– SourceBuffer ä¸å¯ç”¨ï¼Œåœæ­¢å¤„ç†é˜Ÿåˆ—","warning"),this.streamQueue=[];return}if(this.sourceBuffer.updating||this.streamQueue.length===0)return;const e=document.querySelector("#convertedVideoContainer video");if(e&&e.error){this.log(`è§†é¢‘å…ƒç´ é”™è¯¯: ${e.error.message}`,"error"),this.stopStreaming();return}const t=this.analyzeBufferHealth();if(t.shouldWait){this.log(t.message,"warning"),setTimeout(()=>this.processStreamQueue(),t.waitTime);return}const i=this.streamQueue.shift();try{this.log(`æ­£åœ¨æ·»åŠ åˆ†ç‰‡åˆ°SourceBufferï¼Œå¤§å°: ${i.length} å­—èŠ‚`),this.bufferMonitor.totalChunksAdded++,this.bufferMonitor.totalBytesProcessed+=i.length;const r=o=>{this.sourceBuffer.removeEventListener("error",r),this.bufferMonitor.lastErrorTime=Date.now(),this.bufferMonitor.consecutiveErrors++,this.bufferMonitor.bufferHealth="poor",this.log("åˆ†ç‰‡æ·»åŠ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯","error"),this.handleSourceBufferErrorRecovery()};this.sourceBuffer.addEventListener("error",r),setTimeout(()=>{try{if(this.sourceBuffer.appendBuffer(i),this.log(`å·²æ·»åŠ åˆ†ç‰‡åˆ°æ’­æ”¾é˜Ÿåˆ—ï¼Œå‰©ä½™é˜Ÿåˆ—: ${this.streamQueue.length}`),this.bufferMonitor.totalChunksProcessed++,this.bufferMonitor.consecutiveErrors=0,this.bufferMonitor.bufferHealth="good",this.sourceBuffer.removeEventListener("error",r),e&&e.paused){const o=this.sourceBuffer.buffered.length;let s=0;o>0&&(s=this.sourceBuffer.buffered.end(o-1)),s>=3&&setTimeout(()=>{this.attemptAutoPlay(e)},500)}}catch(o){this.sourceBuffer.removeEventListener("error",r),this.handleAppendError(o,i)}},0)}catch(r){this.log(`æ·»åŠ åˆ†ç‰‡å¤±è´¥: ${r.message}`,"error"),console.error("SourceBuffer appendBuffer error:",r),this.handleAppendError(r,i)}}analyzeBufferHealth(){const e={shouldWait:!1,waitTime:1e3,message:""};try{const t=document.querySelector("#convertedVideoContainer video");if(!this.sourceBuffer||!this.sourceBuffer.buffered||this.sourceBuffer.buffered.length===0)return e;const i=this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1),r=t?t.currentTime:0,o=i-r;if(this.sourceBuffer.buffered.length>5)return e.shouldWait=!0,e.message="ç¼“å†²åŒºæ®µæ•°è¿‡å¤šï¼Œæš‚åœæ·»åŠ ",e.waitTime=2e3,e;if(o>30)return e.shouldWait=!0,e.message=`ç¼“å†²åŒºæå‰è¿‡å¤š (${o.toFixed(1)}s)ï¼Œæš‚åœæ·»åŠ `,e.waitTime=2e3,e;if(this.streamQueue.length>5)return e.shouldWait=!0,e.message="é˜Ÿåˆ—è¿‡é•¿ï¼Œæš‚åœæ·»åŠ ",e.waitTime=500,e;if(performance.memory){const s=performance.memory.usedJSHeapSize,n=performance.memory.totalJSHeapSize,u=s/n;if(u>.8)return e.shouldWait=!0,e.message=`å†…å­˜ä½¿ç”¨è¿‡é«˜ (${(u*100).toFixed(1)}%)ï¼Œæš‚åœæ·»åŠ `,e.waitTime=5e3,e}}catch(t){this.log(`åˆ†æç¼“å†²åŒºå¥åº·çŠ¶æ€å¤±è´¥: ${t.message}`,"warning"),e.shouldWait=!0,e.message="ç¼“å†²åŒºåˆ†æå¤±è´¥ï¼Œæš‚åœæ·»åŠ ",e.waitTime=2e3}return e}startPerformanceMonitoring(){this.performanceMonitor&&clearInterval(this.performanceMonitor),this.performanceMonitor=setInterval(()=>{this.logPerformanceStats()},1e4)}stopPerformanceMonitoring(){this.performanceMonitor&&(clearInterval(this.performanceMonitor),this.performanceMonitor=null)}logPerformanceStats(){const e={totalChunksAdded:this.bufferMonitor.totalChunksAdded,totalChunksProcessed:this.bufferMonitor.totalChunksProcessed,totalBytesProcessed:this.bufferMonitor.totalBytesProcessed,queueLength:this.streamQueue.length,bufferHealth:this.bufferMonitor.bufferHealth,consecutiveErrors:this.bufferMonitor.consecutiveErrors,isStreaming:this.isStreaming,memoryUsage:this.performanceMetrics.memoryUsage};this.log(`æ€§èƒ½ç»Ÿè®¡: ${JSON.stringify(e)}`,"debug"),e.consecutiveErrors>5&&(this.log("æ£€æµ‹åˆ°è¿ç»­é”™è¯¯è¿‡å¤šï¼Œè§¦å‘æ¢å¤æœºåˆ¶","warning"),this.handleSourceBufferErrorRecovery())}handleAppendError(e,t){switch(this.log(`å¤„ç† appendBuffer é”™è¯¯: ${e.name} - ${e.message}`,"error"),e.name){case"QuotaExceededError":this.log("ç¼“å†²åŒºé…é¢è¶…å‡ºï¼Œå°è¯•æ¸…ç†æ—§æ•°æ®","warning"),this.handleBufferQuotaExceeded();break;case"InvalidStateError":this.log("SourceBuffer çŠ¶æ€æ— æ•ˆï¼Œå°è¯•æ¢å¤","warning"),this.handleSourceBufferErrorRecovery();break;case"NotSupportedError":this.log("ä¸æ”¯æŒçš„æ•°æ®æ ¼å¼ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–MediaSource","warning"),this.handleFormatIncompatibility();break;default:this.log(`æœªçŸ¥é”™è¯¯ç±»å‹: ${e.name}ï¼Œå°è¯•æ¢å¤`,"warning"),this.handleSourceBufferErrorRecovery();break}}handleFormatIncompatibility(){this.log("å¤„ç†æ ¼å¼ä¸å…¼å®¹é—®é¢˜...","warning"),this.supportedMimeType&&this.supportedMimeType.includes("video/mp2t")?(this.log("å½“å‰ä½¿ç”¨MPEG-TSæ ¼å¼ï¼Œå°è¯•åˆ‡æ¢åˆ°MP4æ ¼å¼","info"),this.stopStreaming(),setTimeout(()=>{if(this.isStreaming){this.log("é‡æ–°åˆå§‹åŒ–MediaSourceï¼Œä¼˜å…ˆä½¿ç”¨MP4æ ¼å¼","info");const e=this.supportedMimeType;this.supportedMimeType='video/mp4; codecs="avc1.42E01E,mp4a.40.2"',this.initMediaSource().catch(t=>{this.log(`é‡æ–°åˆå§‹åŒ–å¤±è´¥: ${t.message}`,"error"),this.supportedMimeType=e})}},2e3)):this.stopStreaming()}handleBufferQuotaExceeded(){try{if(this.sourceBuffer&&this.sourceBuffer.buffered.length>1){const e=this.sourceBuffer.buffered.start(1);this.sourceBuffer.remove(0,e),this.log(`å·²ç§»é™¤ 0-${e.toFixed(2)} çš„ç¼“å†²åŒº`,"info"),setTimeout(()=>this.processStreamQueue(),100)}else this.log("ç¼“å†²åŒºå·²æ»¡ä¸”æ— æ³•æ¸…ç†ï¼Œåœæ­¢æµå¼æ’­æ”¾","warning"),this.stopStreaming()}catch(e){this.log(`æ¸…ç†ç¼“å†²åŒºå¤±è´¥: ${e.message}`,"error"),this.stopStreaming()}}stopStreaming(){this.log("æ­£åœ¨åœæ­¢æµå¼æ’­æ”¾...","info"),this.isStreaming=!1,this.streamQueue=[],this.cleanupMediaSource(),this.updateStreamingStatus("æµå¼æ’­æ”¾å·²åœæ­¢"),this.log("æµå¼æ’­æ”¾å·²åœæ­¢")}cleanupMediaSource(){try{if(this.sourceBuffer)try{if(this.sourceBuffer.removeEventListener("updateend",this.processStreamQueue),this.sourceBuffer.removeEventListener("error",this.handleSourceBufferError),this.sourceBuffer.updating){this.log("ç­‰å¾… SourceBuffer æ›´æ–°å®Œæˆ...","debug"),setTimeout(()=>this.cleanupMediaSource(),100);return}this.mediaSource&&this.mediaSource.sourceBuffers.length>0&&(this.mediaSource.removeSourceBuffer(this.sourceBuffer),this.log("å·²ä» MediaSource ç§»é™¤ SourceBuffer","debug"))}catch(t){this.log(`ç§»é™¤ SourceBuffer å¤±è´¥: ${t.message}`,"warning")}finally{this.sourceBuffer=null}if(this.mediaSource)try{this.mediaSource.readyState==="open"&&(this.mediaSource.endOfStream(),this.log("MediaSource æµå·²ç»“æŸ","debug"))}catch(t){this.log(`ç»“æŸ MediaSource æµå¤±è´¥: ${t.message}`,"warning")}finally{this.mediaSource=null}const e=document.querySelector("#convertedVideoContainer video");e&&e.src.startsWith("blob:")&&(URL.revokeObjectURL(e.src),this.log("å·²æ¸…ç†è§†é¢‘å…ƒç´ çš„ MediaSource URL","debug"))}catch(e){this.log(`æ¸…ç† MediaSource èµ„æºæ—¶å‡ºé”™: ${e.message}`,"error"),console.error("æ¸…ç†èµ„æºå¤±è´¥:",e)}}diagnoseSourceBufferError(e){try{if(this.log("=== SourceBuffer é”™è¯¯è¯Šæ–­ ===","debug"),this.mediaSource?this.log(`MediaSource çŠ¶æ€: ${this.mediaSource.readyState}`,"debug"):this.log("MediaSource å¯¹è±¡ä¸å­˜åœ¨","error"),this.sourceBuffer){this.log(`SourceBuffer æ›´æ–°çŠ¶æ€: ${this.sourceBuffer.updating}`,"debug"),this.log(`SourceBuffer æ¨¡å¼: ${this.sourceBuffer.mode}`,"debug");try{if(this.sourceBuffer.buffered&&this.sourceBuffer.buffered.length>0){this.log(`ç¼“å†²åŒºæ®µæ•°: ${this.sourceBuffer.buffered.length}`,"debug");for(let i=0;i<this.sourceBuffer.buffered.length;i++){const r=this.sourceBuffer.buffered.start(i),o=this.sourceBuffer.buffered.end(i);this.log(`ç¼“å†²åŒº ${i}: ${r.toFixed(2)} - ${o.toFixed(2)}`,"debug")}}else this.log("SourceBuffer ç¼“å†²åŒºä¸ºç©º","debug")}catch(i){this.log(`è®¿é—®ç¼“å†²åŒºå¤±è´¥: ${i.message}`,"warning")}this.log(`æ—¶é—´æˆ³åç§»: ${this.sourceBuffer.timestampOffset}`,"debug"),this.log(`è¿½åŠ çª—å£: ${this.sourceBuffer.appendWindowStart} - ${this.sourceBuffer.appendWindowEnd}`,"debug")}else this.log("SourceBuffer å¯¹è±¡ä¸å­˜åœ¨","error");this.log(`æµé˜Ÿåˆ—é•¿åº¦: ${this.streamQueue.length}`,"debug"),this.log(`æ˜¯å¦æ­£åœ¨æµå¼æ’­æ”¾: ${this.isStreaming}`,"debug");const t=document.querySelector("#convertedVideoContainer video");t&&(this.log(`è§†é¢‘å½“å‰æ—¶é—´: ${t.currentTime}`,"debug"),this.log(`è§†é¢‘å°±ç»ªçŠ¶æ€: ${t.readyState}`,"debug"),this.log(`è§†é¢‘ç½‘ç»œçŠ¶æ€: ${t.networkState}`,"debug"),t.error&&this.log(`è§†é¢‘é”™è¯¯: ${t.error.message}`,"error")),this.log("=== è¯Šæ–­ç»“æŸ ===","debug"),this.handleSourceBufferErrorRecovery()}catch(t){this.log(`è¯Šæ–­è¿‡ç¨‹ä¸­å‡ºé”™: ${t.message}`,"error")}}handleSourceBufferErrorRecovery(){if(this.log("å°è¯• SourceBuffer é”™è¯¯æ¢å¤...","warning"),this.sourceBuffer&&this.mediaSource&&this.mediaSource.readyState==="open")try{if(this.streamQueue=[],this.sourceBuffer.updating){this.log("SourceBuffer æ­£åœ¨æ›´æ–°ï¼Œç­‰å¾…å®Œæˆ...","warning"),setTimeout(()=>this.handleSourceBufferErrorRecovery(),1e3);return}this.safeEndStream(),this.log("SourceBuffer é”™è¯¯æ¢å¤å¤„ç†å®Œæˆ","info");return}catch(e){this.log(`æ¢å¤ç­–ç•¥1å¤±è´¥: ${e.message}`,"error")}this.log("æ‰§è¡Œå®Œå…¨é‡ç½®ç­–ç•¥...","warning"),this.stopStreaming(),setTimeout(()=>{this.isStreaming&&(this.log("å°è¯•é‡æ–°åˆå§‹åŒ– MediaSource...","info"),this.initMediaSource().catch(e=>{this.log(`é‡æ–°åˆå§‹åŒ–å¤±è´¥: ${e.message}`,"error")}))},2e3)}safeEndStream(){if(this.mediaSource&&this.mediaSource.readyState==="open")try{this.sourceBuffer&&!this.sourceBuffer.updating?(this.mediaSource.sourceBuffers.length>0&&(this.mediaSource.removeSourceBuffer(this.sourceBuffer),this.log("å·²ç§»é™¤ SourceBuffer","debug")),this.mediaSource.endOfStream(),this.log("MediaSource æµå·²å®‰å…¨ç»“æŸ","debug")):this.log("SourceBuffer æ­£åœ¨æ›´æ–°æˆ–ä¸å¯ç”¨ï¼Œè·³è¿‡ç»“æŸæµ","warning")}catch(e){this.log(`ç»“æŸMediaSourceæµå¤±è´¥: ${e.message}`,"warning"),console.error("ç»“æŸæµå¤±è´¥è¯¦æƒ…:",e)}}async getVideoDuration(e){const t=["-i",e,"-f","null","-"];try{return await this.ffmpeg.exec(t),this.log("ä½¿ç”¨é»˜è®¤è§†é¢‘æ—¶é•¿: 60ç§’"),60}catch(i){return this.log(`è·å–è§†é¢‘æ—¶é•¿å¤±è´¥: ${i.message}`,"warning"),this.log("ä½¿ç”¨é»˜è®¤è§†é¢‘æ—¶é•¿: 60ç§’"),60}}}document.addEventListener("DOMContentLoaded",()=>{new y});window.addEventListener("error",a=>{console.error("å…¨å±€é”™è¯¯:",a.error),a.error&&a.error.name==="InvalidStateError"&&console.warn("æ£€æµ‹åˆ° SourceBuffer çŠ¶æ€é”™è¯¯ï¼Œå¯èƒ½æ˜¯æ­£å¸¸çš„çŠ¶æ€æ¸…ç†è¿‡ç¨‹")});window.addEventListener("unhandledrejection",a=>{console.error("æœªå¤„ç†çš„ Promise æ‹’ç»:",a.reason)});
//# sourceMappingURL=index-DDhAt2_Y.js.map
